<%
const nav = {
  menu: 'nav-menu', link_classes: 'nav-link', map: [
    {name: 'home', text: lang === 'zh' ? '首页' : 'home'},
    {name: 'bio', text: lang === 'zh' ? '个人简介' : 'bio'},
    {name: 'events', text: lang === 'zh' ? '事件' : 'events'},
    {name: 'music', text: lang === 'zh' ? '音乐' : 'Music', menu: 'drop-down-menu', link_classes: 'drop-down-link', liClass: 'd-sm-none', map: [
      {name: 'works', text: lang === 'zh' ? '作品' : 'Works'},
      {name: 'media', text: lang === 'zh' ? '媒体' : 'Media'},
      {name: 'arranger', text: lang === 'zh' ? '编曲' : 'Arranger', href: 'arrangements'},
    ]},
    {name: 'works', text: lang === 'zh' ? '作品' : 'works', liClass: 'd-none d-sm-block'},
    {name: 'media', text: lang === 'zh' ? '媒体' : 'media', liClass: 'd-none d-sm-block'},
    {name: 'arranger', text: lang === 'zh' ? '编曲' : 'arranger', liClass: 'd-none d-sm-block', href: 'arrangements'},
    {name: 'contact', text: lang === 'zh' ? '联系' : 'contact', liClass: 'last-child'},
  ]
}

const generateMenu = data => {
  let html = `<ul class="${data.menu}">`;
  data.map.forEach(item => {
    const name = item.name;
    const text = item.text || item.name;
    const liClass = item.liClass || '';
    let href = (item.name === 'home' || name === '首页') ? '/' : (item.href || `/${name}`);
    href += '?lang=' + lang;
    if (!item.menu) html += `<li class="${liClass}"><a href='${href}' class="${data.link_classes}">${text}</a></li>`;
    else { html += `<li class="${item.menu + '--parent'} ${liClass}"><span>${text}</span>${generateMenu(item)}</li>`}
  })
  html +=`</ul>`
  return html;
}
%>

<nav>

  <%- generateMenu(nav) %>

  <div id="burger">
    <div></div>
    <div></div>
    <div></div>
  </div>
</nav>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Getting the current path and removing query parameters
    let path = window.location.pathname;
    let links = document.getElementsByClassName('nav-link');

    for (let i = 0; i < links.length; i++) {
      let href = links[i].getAttribute('href');
      // Splitting href on '?' to remove any query parameters
      href = href.split('?')[0];
      // Check if the href attribute of the link matches the current path
      if (href === path) {
        // Add 'active' class to the matching link
        links[i].classList.add('active');
        break;
      }
    }

    // add gradient html
    let ul = document.querySelector('.nav-menu');
    let html = `<div id="gradient"></div>`;
    ul.insertAdjacentHTML('beforeend', html);

    // drop down
    document.querySelectorAll('.drop-down-menu--parent').forEach(parent => {
      parent.addEventListener('mouseenter', function(ev) {
        let dropdown = this.querySelector('.drop-down-menu');
        let rect = this.getBoundingClientRect();
        dropdown.style.top = `${rect.top + rect.height}px`;
        dropdown.style.left = `${window.scrollX + rect.left}px`;
        dropdown.style.minWidth = `calc(${rect.width}px + (15px * 2))`; // set min-width
        dropdown.style.display = 'flex';
      });
      parent.addEventListener('mouseleave', function(ev) {
        this.querySelector('.drop-down-menu').style.display = 'none';
      });
    });

  });
</script>

<script>
  const currentPath = window.location.pathname.replace(/\/$/, '');
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.toggle('active', link.getAttribute('href') === currentPath || (link.getAttribute('href') === '/' && currentPath === ''));
  });
</script>

<script src="/js/gradient-no-scroll.js" defer></script>